<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Precificação BPO Financeiro com Proposta</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #0d47a1;
            --secondary-color: #1976d2;
            --accent-color: #42a5f5;
            --background-color: #f5f7fa;
            --text-color: #333;
            --card-background: #ffffff;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            transition: background-color 0.3s;
        }
        .card {
            background-color: var(--card-background);
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease-in-out;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            transition: background-color 0.3s;
        }
        .btn-primary:hover {
            background-color: var(--secondary-color);
        }
        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
            transition: background-color 0.3s;
        }
        .btn-secondary:hover {
            background-color: var(--accent-color);
        }
        .term-card.active {
            border-color: var(--primary-color);
            transform: scale(1.02);
            box-shadow: 0 0 15px rgba(13, 71, 161, 0.3);
        }
        .scenario-card.active {
             border-color: var(--primary-color);
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(13, 71, 161, 0.3);
        }
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 28px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-color); }
        input:checked + .slider:before { transform: translateX(22px); }
        .payment-options { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out; }
        .term-card.active .payment-options { max-height: 100px; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-bold header-title" style="color: var(--primary-color);">Calculadora de Precificação BPO</h1>
            <p class="text-lg text-gray-600 mt-2">Estime o valor dos seus serviços e gere uma proposta profissional.</p>
        </header>

        <!-- Seção Principal -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Coluna Esquerda: Serviços e Cenários -->
            <div class="lg:col-span-2 space-y-6">
                <div class="card p-6">
                    <h2 class="text-2xl font-bold mb-4 header-title" style="color: var(--primary-color);">1. Seleção de Serviços</h2>
                    <div id="services-list" class="space-y-4"></div>
                </div>

                <div class="card p-6">
                    <h2 class="text-2xl font-bold mb-4 header-title" style="color: var(--primary-color);">2. Cenários de Precificação</h2>
                     <div class="p-2 mb-4 text-sm text-blue-700 bg-blue-100 rounded-lg">
                        <p>Os cenários são baseados na sua Margem de Lucro Padrão, definida nas Configurações Avançadas.</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div id="scenario-conservative" class="scenario-card border-2 border-gray-200 rounded-lg p-4 text-center cursor-pointer transition-all"><h3 class="font-bold text-lg">Conservador</h3><p class="text-sm text-gray-500">Lucro <span id="conservative-profit-margin">18%</span></p></div>
                        <div id="scenario-moderate" class="scenario-card border-2 border-gray-200 rounded-lg p-4 text-center cursor-pointer transition-all"><h3 class="font-bold text-lg">Moderado</h3><p class="text-sm text-gray-500">Lucro <span id="moderate-profit-margin">30%</span></p></div>
                        <div id="scenario-aggressive" class="scenario-card border-2 border-gray-200 rounded-lg p-4 text-center cursor-pointer transition-all"><h3 class="font-bold text-lg">Agressivo</h3><p class="text-sm text-gray-500">Lucro <span id="aggressive-profit-margin">42%</span></p></div>
                    </div>
                </div>

                <div class="card p-6">
                    <h2 class="text-2xl font-bold mb-4 header-title" style="color: var(--primary-color);">3. Prazo e Forma de Pagamento</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div id="term-monthly" class="term-card border-2 border-gray-200 rounded-lg p-4 cursor-pointer transition-all"><div class="text-center"><h3 class="font-bold text-lg">Mensal</h3><p class="text-sm text-gray-500">Sem desconto</p></div><div class="payment-options mt-3 space-y-2 text-sm"><label class="flex items-center"><input type="radio" name="payment-method" value="Boleto" class="mr-2">Boleto</label><label class="flex items-center"><input type="radio" name="payment-method" value="PIX Mensal" class="mr-2">PIX</label></div></div>
                        <div id="term-quarterly" class="term-card border-2 border-gray-200 rounded-lg p-4 cursor-pointer transition-all"><div class="text-center"><h3 class="font-bold text-lg">Trimestral</h3><p class="text-sm text-gray-500">5% de Desconto (+2% no PIX)</p></div><div class="payment-options mt-3 space-y-2 text-sm"><label class="flex items-center"><input type="radio" name="payment-method" value="Cartão de Crédito Trimestral" class="mr-2">Cartão de Crédito</label><label class="flex items-center"><input type="radio" name="payment-method" value="PIX Trimestral" class="mr-2">PIX</label></div></div>
                        <div id="term-annually" class="term-card border-2 border-gray-200 rounded-lg p-4 cursor-pointer transition-all"><div class="text-center"><h3 class="font-bold text-lg">Anual</h3><p class="text-sm text-gray-500">10% de Desconto (+2% no PIX)</p></div><div class="payment-options mt-3 space-y-2 text-sm"><label class="flex items-center"><input type="radio" name="payment-method" value="Cartão de Crédito Anual" class="mr-2">Cartão de Crédito</label><label class="flex items-center"><input type="radio" name="payment-method" value="PIX Anual" class="mr-2">PIX</label></div></div>
                    </div>
                </div>
                
                <div class="card p-6">
                    <h2 class="text-2xl font-bold mb-4 header-title" style="color: var(--primary-color);">4. Gerenciar Biblioteca de Serviços</h2>
                    <div class="p-2 mb-4 text-sm text-blue-700 bg-blue-100 rounded-lg">
                        <p>Suas alterações na biblioteca são salvas automaticamente no navegador.</p>
                    </div>
                    <div id="service-library-list" class="space-y-3 max-h-96 overflow-y-auto pr-2"></div>
                    <div class="flex space-x-4 mt-4">
                        <button id="btn-save-default" class="w-full btn-secondary font-bold py-2 px-4 rounded-lg">Salvar como Padrão</button>
                        <button id="btn-restore-default" class="w-full bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">Restaurar Padrão</button>
                    </div>
                    <hr class="my-6">
                    <h3 class="text-xl font-bold mb-4">Adicionar Novo Serviço à Biblioteca</h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                        <div class="md:col-span-2">
                            <label for="lib-new-service-name" class="block text-sm font-medium text-gray-700">Nome do Serviço</label>
                            <input id="lib-new-service-name" type="text" placeholder="Ex: Fechamento Mensal" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                        </div>
                        <div>
                            <label for="lib-new-service-time" class="block text-sm font-medium text-gray-700">Tempo/unidade</label>
                            <input id="lib-new-service-time" type="number" placeholder="Ex: 60" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                        </div>
                        <div>
                            <label for="lib-new-service-value" class="block text-sm font-medium text-gray-700">Valor (R$)</label>
                            <input id="lib-new-service-value" type="number" placeholder="Ex: 150" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                        </div>
                    </div>
                     <button id="btn-lib-add-new-service" class="mt-4 w-full btn-secondary font-bold py-2 px-4 rounded-lg flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                        Adicionar à Biblioteca
                    </button>
                </div>

            </div>

            <!-- Coluna Direita: Resumo -->
            <div class="space-y-6">
                <div class="card p-6 sticky top-8">
                    <h2 class="text-2xl font-bold mb-4 header-title" style="color: var(--primary-color);">Resumo da Precificação</h2>
                    <div class="space-y-3 text-gray-700">
                        <div class="flex justify-between"><span>Custo Operacional:</span> <span id="summary-cost" class="font-semibold">R$ 0,00</span></div>
                        <div class="flex justify-between"><span>Comissão Vendas:</span> <span id="summary-commission" class="font-semibold">R$ 0,00</span></div>
                        <div class="flex justify-between"><span>Impostos (Simples):</span> <span id="summary-tax" class="font-semibold">R$ 0,00</span></div>
                        <div class="flex justify-between"><span>Margem de Lucro:</span> <span id="summary-profit" class="font-semibold">R$ 0,00</span></div>
                        <hr class="my-2">
                        <div class="flex justify-between text-lg"><span class="font-bold">Subtotal:</span><span id="summary-subtotal" class="font-bold">R$ 0,00</span></div>
                        <div class="flex justify-between text-green-600"><span>Desconto Prazo:</span><span id="summary-discount" class="font-semibold">- R$ 0,00</span></div>
                    </div>
                    <div class="mt-6 p-4 rounded-lg text-center accent-bg" style="background-color: var(--accent-color);">
                        <p class="text-lg font-semibold text-white">Valor Final do Serviço</p>
                        <p id="summary-total" class="text-4xl font-bold text-white">R$ 0,00</p>
                    </div>
                    <button id="btn-generate-proposal" class="mt-4 w-full btn-primary font-bold py-3 px-4 rounded-lg flex items-center justify-center text-lg">
                        <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
                        Gerar Proposta (PDF)
                    </button>
                </div>
            </div>
        </div>

        <!-- Seção de Configurações Inferior -->
        <div class="mt-8 grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="card p-6">
                <h3 class="text-xl font-bold mb-4 header-title" style="color: var(--primary-color);">Configurações Avançadas</h3>
                <div class="space-y-4">
                    <div><label for="fixed-cost" class="block text-sm font-medium text-gray-700">Custo Fixo Mensal (R$)</label><input type="number" id="fixed-cost" value="800" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></div>
                    <div><label for="hours-month" class="block text-sm font-medium text-gray-700">Horas Trabalhadas/Mês (por pessoa)</label><input type="number" id="hours-month" value="48" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></div>
                    <div><label for="team-size" class="block text-sm font-medium text-gray-700">Pessoas na Operação</label><input type="number" id="team-size" value="1" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></div>
                    <div><label for="cost-hour" class="block text-sm font-medium text-gray-700">Custo por Hora (R$) <span class="text-xs text-gray-400">(Calculado)</span></label><input type="number" id="cost-hour" value="16.67" step="0.01" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 bg-gray-100 cursor-not-allowed" readonly></div>
                    <div><label for="profit-margin" class="block text-sm font-medium text-gray-700">Margem de Lucro Padrão (%)</label><input type="number" id="profit-margin" value="30" step="0.1" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></div>
                    <div><label for="simple-rate" class="block text-sm font-medium text-gray-700">Alíquota Simples Nacional (%)</label><input type="number" id="simple-rate" value="6" step="0.1" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></div>
                    <div><label for="commission-rate" class="block text-sm font-medium text-gray-700">Comissão de Vendas (%)</label><input type="number" id="commission-rate" value="0" step="0.1" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></div>
                </div>
            </div>
            
            <div class="card p-6">
                <h3 class="text-xl font-bold mb-4 header-title" style="color: var(--primary-color);">Personalize sua Proposta</h3>
                <div class="space-y-4">
                    <div><label for="company-name" class="block text-sm font-medium text-gray-700">Nome da Empresa</label><input type="text" id="company-name" placeholder="Sua Empresa LTDA" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></div>
                    <div><label for="company-slogan" class="block text-sm font-medium text-gray-700">Slogan da Empresa</label><input type="text" id="company-slogan" placeholder="Sua solução em BPO Financeiro" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></div>
                    <div><label for="contact-email" class="block text-sm font-medium text-gray-700">E-mail de Contato</label><input type="email" id="contact-email" placeholder="contato@suaempresa.com" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></div>
                    <div><label for="contact-whatsapp" class="block text-sm font-medium text-gray-700">WhatsApp</label><input type="text" id="contact-whatsapp" placeholder="(XX) XXXXX-XXXX" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></div>
                    <hr class="my-1">
                    <h4 class="text-md font-semibold text-gray-800 pt-1">Dados do Cliente</h4>
                    <div><label for="client-name" class="block text-sm font-medium text-gray-700">Nome do Cliente</label><input type="text" id="client-name" placeholder="Nome do Contato" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></div>
                    <div><label for="client-company" class="block text-sm font-medium text-gray-700">Empresa do Cliente</label><input type="text" id="client-company" placeholder="Empresa XYZ" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></div>
                    <hr class="my-1">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Logo da Empresa</label>
                        <div class="mt-1 flex items-center space-x-4">
                            <img id="logo-preview" src="https://placehold.co/100x40/f5f7fa/333?text=Logo" alt="Prévia do Logo" class="h-10 bg-gray-100 rounded object-contain">
                            <label for="logo-upload" class="cursor-pointer bg-white py-2 px-3 border border-gray-300 rounded-md shadow-sm text-sm leading-4 font-medium text-gray-700 hover:bg-gray-50">
                                <span>Carregar arquivo</span>
                                <input id="logo-upload" name="logo-upload" type="file" class="sr-only" accept="image/png, image/jpeg, image/gif">
                            </label>
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-4">
                        <div><label for="primary-color-picker" class="block text-sm font-medium text-gray-700">Cor Principal</label><input type="color" id="primary-color-picker" value="#0d47a1" class="mt-1 h-10 block w-full border border-gray-300 rounded-md p-1"></div>
                        <div><label for="accent-color-picker" class="block text-sm font-medium text-gray-700">Cor Destaque</label><input type="color" id="accent-color-picker" value="#42a5f5" class="mt-1 h-10 block w-full border border-gray-300 rounded-md p-1"></div>
                        <div><label for="background-color-picker" class="block text-sm font-medium text-gray-700">Cor Fundo</label><input type="color" id="background-color-picker" value="#f5f7fa" class="mt-1 h-10 block w-full border border-gray-300 rounded-md p-1"></div>
                    </div>
                    <button id="btn-apply-custom" class="w-full btn-secondary font-bold py-2 px-4 rounded-lg">Aplicar Customização</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DATA STORE ---
        const initialServices = [
            { id: 1, name: 'Emissão de NF automática', time: 1, value: 0, quantity: 10, active: false },
            { id: 2, name: 'Emissão de NF avulsa', time: 3, value: 0, quantity: 1, active: false },
            { id: 3, name: 'Emissão de boleto automático', time: 5, value: 0, quantity: 5, active: false },
            { id: 4, name: 'Emissão de boleto avulso', time: 10, value: 0, quantity: 1, active: false },
            { id: 5, name: 'Registros de recebimentos', time: 5, value: 0, quantity: 100, active: false },
            { id: 6, name: 'Registros de pagamentos', time: 5, value: 0, quantity: 50, active: false },
            { id: 7, name: 'Agendamento de pagamentos', time: 3, value: 0, quantity: 50, active: false },
            { id: 8, name: 'Conciliação bancária', time: 20, value: 0, quantity: 1, active: false },
            { id: 9, name: 'Gestão de contas a receber', time: 30, value: 0, quantity: 1, active: false },
            { id: 10, name: 'Gestão de contas a pagar', time: 30, value: 0, quantity: 1, active: false },
            { id: 11, name: 'Fluxo de caixa', time: 30, value: 0, quantity: 1, active: false },
            { id: 12, name: 'Gestão de indicadores', time: 40, value: 0, quantity: 1, active: false },
            { id: 13, name: 'Gestão de plataforma de recebimento', time: 10, value: 0, quantity: 1, active: false },
            { id: 14, name: 'Conciliação de fatura de cartão', time: 15, value: 0, quantity: 1, active: false },
            { id: 15, name: 'Reunião mensal de uma hora', time: 60, value: 150, quantity: 1, active: false }
        ];
        let services = [];
        let config = { fixedCost: 800, hoursPerMonth: 48, teamSize: 1, costPerHour: 16.67, profitMargin: 0.30, simpleRate: 0.06, commissionRate: 0 };
        let scenarios = { conservative: { profitMargin: 0.18 }, moderate: { profitMargin: 0.30 }, aggressive: { profitMargin: 0.42 } };
        const paymentTerms = {
            'Boleto': { discount: 0, label: 'Mensal via Boleto (sem desconto adicional)' },
            'PIX Mensal': { discount: 0, label: 'Mensal via PIX' },
            'Cartão de Crédito Trimestral': { discount: 0.05, label: 'Trimestral via Cartão de Crédito' },
            'PIX Trimestral': { discount: 0.07, label: 'Trimestral via PIX' },
            'Cartão de Crédito Anual': { discount: 0.10, label: 'Anual via Cartão de Crédito' },
            'PIX Anual': { discount: 0.12, label: 'Anual via PIX' }
        };
        let currentScenario = 'moderate';
        let currentPaymentMethod = 'Boleto';

        // --- FUNCTIONS ---
        const formatCurrency = (value) => value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

        const updateAllCalculations = () => {
            config.fixedCost = parseFloat(document.getElementById('fixed-cost').value) || 0;
            config.hoursPerMonth = parseFloat(document.getElementById('hours-month').value) || 1;
            config.teamSize = parseInt(document.getElementById('team-size').value) || 1;
            config.simpleRate = (parseFloat(document.getElementById('simple-rate').value) || 0) / 100;
            config.commissionRate = (parseFloat(document.getElementById('commission-rate').value) || 0) / 100;
            config.profitMargin = (parseFloat(document.getElementById('profit-margin').value) || 0) / 100;

            const totalHours = config.teamSize * config.hoursPerMonth;
            const calculatedCostPerHour = totalHours > 0 ? config.fixedCost / totalHours : 0;
            document.getElementById('cost-hour').value = calculatedCostPerHour.toFixed(2);
            config.costPerHour = calculatedCostPerHour;

            scenarios.moderate.profitMargin = config.profitMargin;
            scenarios.conservative.profitMargin = config.profitMargin * 0.6;
            scenarios.aggressive.profitMargin = config.profitMargin * 1.4;

            document.getElementById('moderate-profit-margin').textContent = `${(scenarios.moderate.profitMargin * 100).toFixed(0)}%`;
            document.getElementById('conservative-profit-margin').textContent = `${(scenarios.conservative.profitMargin * 100).toFixed(0)}%`;
            document.getElementById('aggressive-profit-margin').textContent = `${(scenarios.aggressive.profitMargin * 100).toFixed(0)}%`;

            const activeServices = services.filter(s => s.active);
            
            const operationalCost = activeServices.reduce((total, service) => {
                let costOfThisService = 0;
                if (service.value && service.value > 0) {
                    costOfThisService = service.value * service.quantity;
                } else {
                    const totalMinutesForService = service.time * service.quantity;
                    costOfThisService = (totalMinutesForService / 60) * config.costPerHour;
                }
                return total + costOfThisService;
            }, 0);

            const profitMarginRate = scenarios[currentScenario].profitMargin;
            
            const denominator = 1 - config.simpleRate - config.commissionRate - profitMarginRate;
            let sellingPrice = denominator > 0 ? operationalCost / denominator : operationalCost * (1 + config.simpleRate + config.commissionRate + profitMarginRate);

            const commissionValue = sellingPrice * config.commissionRate;
            const taxValue = sellingPrice * config.simpleRate;
            const profitValue = sellingPrice * profitMarginRate;
            const discountRate = paymentTerms[currentPaymentMethod]?.discount || 0;
            const discountValue = sellingPrice * discountRate;
            const finalPrice = sellingPrice - discountValue;

            document.getElementById('summary-cost').textContent = formatCurrency(operationalCost);
            document.getElementById('summary-commission').textContent = formatCurrency(commissionValue);
            document.getElementById('summary-tax').textContent = formatCurrency(taxValue);
            document.getElementById('summary-profit').textContent = formatCurrency(profitValue);
            document.getElementById('summary-subtotal').textContent = formatCurrency(sellingPrice);
            document.getElementById('summary-discount').textContent = `- ${formatCurrency(discountValue)}`;
            document.getElementById('summary-total').textContent = formatCurrency(finalPrice);
        };

        const renderServices = () => {
            const list = document.getElementById('services-list');
            list.innerHTML = '';
            services.forEach(s => {
                const priceInfo = s.value && s.value > 0 
                    ? `${formatCurrency(s.value)}/unidade` 
                    : `${s.time} min/unidade`;

                const el = document.createElement('div');
                el.className = `p-4 rounded-lg flex items-center justify-between transition-all ${s.active ? 'bg-blue-50 border-l-4 border-blue-500' : 'bg-gray-50'}`;
                el.innerHTML = `<div class="flex items-center"><label class="switch mr-4"><input type="checkbox" data-id="${s.id}" class="service-toggle" ${s.active ? 'checked' : ''}><span class="slider"></span></label><div><p class="font-semibold text-gray-800">${s.name}</p><p class="text-sm text-gray-500">${priceInfo}</p></div></div><div class="flex items-center space-x-2"><label for="qty-${s.id}" class="text-sm text-gray-600">Qtd:</label><input type="number" data-id="${s.id}" value="${s.quantity}" min="1" class="w-20 p-1 border border-gray-300 rounded-md text-center service-qty" ${!s.active ? 'disabled' : ''}><button data-id="${s.id}" class="text-gray-400 hover:text-red-500 transition-colors service-remove-from-list" title="Remover da seleção"><svg class="w-5 h-5 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button></div>`;
                list.appendChild(el);
            });
        };
        
        const renderServiceLibrary = () => {
            const libraryList = document.getElementById('service-library-list');
            libraryList.innerHTML = '';
            const header = document.createElement('div');
            header.className = 'grid grid-cols-6 gap-3 items-center px-2 font-bold text-sm text-gray-500';
            header.innerHTML = `<div class="col-span-2">Nome do Serviço</div><div>Tempo/unidade</div><div>Valor (R$)</div><div class="col-span-2 text-right">Ações</div>`;
            libraryList.appendChild(header);

            services.forEach(service => {
                const el = document.createElement('div');
                el.className = 'grid grid-cols-6 gap-3 items-center p-2 rounded-md hover:bg-gray-50';
                el.innerHTML = `
                    <div class="col-span-2">
                        <input type="text" value="${service.name}" data-id="${service.id}" class="lib-service-name w-full p-1 border border-gray-300 rounded-md text-sm">
                    </div>
                    <div>
                        <input type="number" value="${service.time}" data-id="${service.id}" class="lib-service-time w-full p-1 border border-gray-300 rounded-md text-sm">
                    </div>
                     <div>
                        <input type="number" value="${service.value || 0}" data-id="${service.id}" class="lib-service-value w-full p-1 border border-gray-300 rounded-md text-sm" step="0.01">
                    </div>
                    <div class="col-span-2 flex justify-end space-x-2">
                         <button data-id="${service.id}" class="lib-service-update text-xs py-1 px-2 rounded-md bg-blue-500 text-white hover:bg-blue-600">Salvar</button>
                         <button data-id="${service.id}" class="lib-service-delete text-xs py-1 px-2 rounded-md bg-red-500 text-white hover:bg-red-600">Excluir</button>
                    </div>
                `;
                libraryList.appendChild(el);
            });
        };

        const selectScenario = (scenario) => {
            currentScenario = scenario;
            document.querySelectorAll('.scenario-card').forEach(c => c.classList.remove('active'));
            document.getElementById(`scenario-${scenario}`).classList.add('active');
            updateAllCalculations();
        };

        const lightenDarkenColor = (col, amt) => {
            let usePound = false;
            if (col[0] === "#") { col = col.slice(1); usePound = true; }
            const num = parseInt(col, 16);
            let r = (num >> 16) + amt;
            if (r > 255) r = 255; else if (r < 0) r = 0;
            let b = ((num >> 8) & 0x00FF) + amt;
            if (b > 255) b = 255; else if (b < 0) b = 0;
            let g = (num & 0x0000FF) + amt;
            if (g > 255) g = 255; else if (g < 0) g = 0;
            return (usePound ? "#" : "") + (g | (b << 8) | (r << 16)).toString(16).padStart(6, '0');
        };

        const applyCustomization = () => {
            const primaryColor = document.getElementById('primary-color-picker').value;
            const accentColor = document.getElementById('accent-color-picker').value;
            const backgroundColor = document.getElementById('background-color-picker').value;
            
            document.documentElement.style.setProperty('--primary-color', primaryColor);
            document.documentElement.style.setProperty('--secondary-color', lightenDarkenColor(primaryColor, 40));
            document.documentElement.style.setProperty('--accent-color', accentColor);
            document.documentElement.style.setProperty('--background-color', backgroundColor);
        };

        const generateProposal = () => {
            const finalPrice = document.getElementById('summary-total').textContent;
            const logoUrl = document.getElementById('logo-preview').src;
            const primaryColor = document.getElementById('primary-color-picker').value;
            const companyName = document.getElementById('company-name').value || 'Sua Empresa';
            const companySlogan = document.getElementById('company-slogan').value || 'Sua solução em BPO Financeiro';
            const contactEmail = document.getElementById('contact-email').value || 'contato@suaempresa.com';
            const contactWhatsapp = document.getElementById('contact-whatsapp').value || '(XX) XXXXX-XXXX';
            const clientName = document.getElementById('client-name').value || 'Nome do Cliente';
            const clientCompany = document.getElementById('client-company').value || 'Empresa do Cliente';
            const activeServices = services.filter(s => s.active);
            
            const servicesHtml = activeServices.map(s => `<tr class="border-b border-gray-200"><td class="py-3 px-4">${s.name}</td><td class="py-3 px-4 text-center">${s.quantity}</td></tr>`).join('');
            const paymentCondition = paymentTerms[currentPaymentMethod]?.label || 'Não definida';

            const proposalHtml = `<html><head><title>Proposta de Serviços - ${companyName}</title><script src="https://cdn.tailwindcss.com"><\/script><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet"><style>@media print{body{-webkit-print-color-adjust:exact}.no-print{display:none}}body{font-family:'Roboto',sans-serif}.text-primary{color:${primaryColor}}</style></head><body class="bg-gray-100 p-4 sm:p-8"><div class="max-w-4xl mx-auto bg-white p-8 sm:p-12 rounded-lg shadow-2xl"><header class="flex justify-between items-start pb-6 border-b-2 mb-10" style="border-color:${primaryColor};"><div class="flex items-center"><img src="${logoUrl}" alt="Logo da Empresa" style="max-height:50px;margin-right:16px;"><div><h1 class="text-2xl font-bold text-primary">${companyName}</h1><p class="text-sm text-gray-500">${companySlogan}</p></div></div><div class="text-right"><h2 class="text-2xl font-bold text-gray-700">Proposta Comercial</h2><p class="text-sm text-gray-500">Data: ${new Date().toLocaleDateString('pt-BR')}</p></div></header><main><div class="mb-10"><h3 class="text-sm font-bold text-gray-500 uppercase tracking-wider mb-2">Preparado para</h3><p class="text-xl font-bold text-gray-800">${clientName}</p><p class="text-md text-gray-600">${clientCompany}</p></div><h2 class="text-xl font-bold mb-4 text-primary">Escopo dos Serviços</h2><p class="mb-6 text-gray-600">Apresentamos nossa proposta para a prestação de serviços de BPO Financeiro, visando otimizar a gestão e a eficiência da sua empresa.</p><table class="w-full text-left mb-10"><thead><tr class="bg-gray-100" style="border-bottom:2px solid ${primaryColor};"><th class="py-3 px-4 font-bold text-sm text-gray-600 uppercase">Serviço</th><th class="py-3 px-4 font-bold text-sm text-gray-600 uppercase text-center">Quantidade Mensal</th></tr></thead><tbody>${servicesHtml}</tbody></table><div class="flex justify-end"><div class="w-full md:w-1/2"><h2 class="text-xl font-bold mb-4 text-primary">Investimento</h2><div class="bg-gray-50 p-6 rounded-lg"><div class="flex justify-between items-center text-gray-600"><span>Subtotal</span><span>${document.getElementById('summary-subtotal').textContent}</span></div><div class="flex justify-between items-center text-green-600 my-2"><span>Desconto</span><span>${document.getElementById('summary-discount').textContent}</span></div><hr class="my-3"><div class="flex justify-between items-center text-2xl font-bold text-primary"><span>Total Mensal</span><span>${finalPrice}</span></div><p class="text-xs text-gray-500 mt-2 text-right">Condição: ${paymentCondition}</p></div></div></div></main><footer class="mt-16 pt-6 border-t text-center text-gray-500 text-xs"><p><strong>${companyName}</strong> | ${contactEmail} | ${contactWhatsapp}</p><p>Esta proposta é válida por 7 dias. Agradecemos pela oportunidade e confiança.</p></footer></div><div class="text-center mt-6 no-print"><button onclick="window.print()" class="bg-blue-600 text-white py-2 px-6 rounded-lg hover:bg-blue-700">Imprimir / Salvar PDF</button></div></body></html>`;
            
            const proposalWindow = window.open('', '_blank');
            proposalWindow.document.write(proposalHtml);
            proposalWindow.document.close();
        };

        // --- LOCAL STORAGE FUNCTIONS ---
        const saveServicesToLocalStorage = () => {
            localStorage.setItem('bpoServices', JSON.stringify(services));
        };

        const loadServicesFromLocalStorage = () => {
            const savedServices = localStorage.getItem('bpoServices');
            if (savedServices) {
                services = JSON.parse(savedServices);
            } else {
                services = JSON.parse(JSON.stringify(initialServices));
            }
        };
        
        const saveDefaultServices = () => {
            localStorage.setItem('bpoDefaultServices', JSON.stringify(services));
            alert('Biblioteca de serviços salva como padrão!');
        };

        const restoreDefaultServices = () => {
            if (confirm('Tem certeza que deseja restaurar a biblioteca padrão? Suas alterações atuais serão perdidas.')) {
                const defaultServices = localStorage.getItem('bpoDefaultServices');
                if (defaultServices) {
                    services = JSON.parse(defaultServices);
                } else {
                    services = JSON.parse(JSON.stringify(initialServices));
                }
                saveServicesToLocalStorage();
                renderAll();
            }
        };

        const renderAll = () => {
            renderServices();
            renderServiceLibrary();
            updateAllCalculations();
        };

        // --- EVENT LISTENERS ---
        const setupEventListeners = () => {
            document.getElementById('scenario-conservative').addEventListener('click', () => selectScenario('conservative'));
            document.getElementById('scenario-moderate').addEventListener('click', () => selectScenario('moderate'));
            document.getElementById('scenario-aggressive').addEventListener('click', () => selectScenario('aggressive'));

            document.querySelectorAll('input[name="payment-method"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    currentPaymentMethod = e.target.value;
                    document.querySelectorAll('.term-card').forEach(c => c.classList.remove('active'));
                    const parentCard = e.target.closest('.term-card');
                    if (parentCard) {
                        parentCard.classList.add('active');
                    }
                    updateAllCalculations();
                });
            });

            document.querySelectorAll('.term-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    if (e.target.matches('input[type="radio"]') || e.target.closest('label')) {
                        return;
                    }
                    document.querySelectorAll('.term-card').forEach(c => c.classList.remove('active'));
                    card.classList.add('active');
                    const isAnyRadioChecked = card.querySelector('input[type="radio"]:checked');
                    if (!isAnyRadioChecked) {
                        const firstRadio = card.querySelector('input[type="radio"]');
                        if (firstRadio) {
                            firstRadio.checked = true;
                            firstRadio.dispatchEvent(new Event('change', { bubbles: true }));
                        }
                    }
                });
            });
            
            const configInputs = ['fixed-cost', 'hours-month', 'team-size', 'simple-rate', 'commission-rate', 'profit-margin'];
            configInputs.forEach(id => {
                document.getElementById(id).addEventListener('input', updateAllCalculations);
            });

            document.getElementById('btn-apply-custom').addEventListener('click', applyCustomization);
            document.getElementById('btn-generate-proposal').addEventListener('click', generateProposal);

            document.getElementById('logo-upload').addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => { document.getElementById('logo-preview').src = e.target.result; };
                    reader.readAsDataURL(file);
                }
            });

            document.getElementById('services-list').addEventListener('change', (e) => {
                const id = parseInt(e.target.dataset.id, 10);
                const service = services.find(s => s.id === id);
                if (!service) return;

                if (e.target.classList.contains('service-toggle')) {
                    service.active = !service.active;
                    renderServices();
                }
                if (e.target.classList.contains('service-qty')) {
                    service.quantity = parseInt(e.target.value, 10) || 1;
                }
                saveServicesToLocalStorage();
                updateAllCalculations();
            });

            document.getElementById('services-list').addEventListener('click', (e) => {
                if (e.target.classList.contains('service-remove-from-list')) {
                    const id = parseInt(e.target.dataset.id, 10);
                    const service = services.find(s => s.id === id);
                    if (service) {
                        service.active = false;
                        saveServicesToLocalStorage();
                        renderServices();
                        updateAllCalculations();
                    }
                }
            });

            document.getElementById('service-library-list').addEventListener('click', (e) => {
                const id = parseInt(e.target.dataset.id, 10);
                if (!id) return;

                if (e.target.classList.contains('lib-service-update')) {
                    const service = services.find(s => s.id === id);
                    if (service) {
                        const nameInput = document.querySelector(`.lib-service-name[data-id='${id}']`);
                        const timeInput = document.querySelector(`.lib-service-time[data-id='${id}']`);
                        const valueInput = document.querySelector(`.lib-service-value[data-id='${id}']`);
                        
                        service.name = nameInput.value;
                        service.time = parseInt(timeInput.value, 10) || 0;
                        service.value = parseFloat(valueInput.value) || 0;
                        
                        saveServicesToLocalStorage();
                        renderAll();
                    }
                }

                if (e.target.classList.contains('lib-service-delete')) {
                    if (confirm(`Tem certeza que deseja excluir "${services.find(s => s.id === id).name}" da biblioteca? Esta ação é permanente.`)) {
                        services = services.filter(s => s.id !== id);
                        saveServicesToLocalStorage();
                        renderAll();
                    }
                }
            });

            document.getElementById('btn-lib-add-new-service').addEventListener('click', () => {
                 const nameInput = document.getElementById('lib-new-service-name');
                 const timeInput = document.getElementById('lib-new-service-time');
                 const valueInput = document.getElementById('lib-new-service-value');
                 
                 const name = nameInput.value;
                 const time = parseInt(timeInput.value, 10) || 0;
                 const value = parseFloat(valueInput.value) || 0;

                 if (name) {
                    const newId = services.length > 0 ? Math.max(...services.map(s => s.id)) + 1 : 1;
                    services.push({ id: newId, name, time, value, quantity: 1, active: false });
                    
                    nameInput.value = '';
                    timeInput.value = '';
                    valueInput.value = '';
                    
                    saveServicesToLocalStorage();
                    renderAll();
                 } else {
                    alert('Por favor, preencha pelo menos o nome do serviço.');
                 }
            });
            
            document.getElementById('btn-save-default').addEventListener('click', saveDefaultServices);
            document.getElementById('btn-restore-default').addEventListener('click', restoreDefaultServices);
        };

        // --- INITIALIZATION ---
        const init = () => {
            try {
                loadServicesFromLocalStorage();
                renderAll();
                const firstPaymentMethod = document.querySelector('input[name="payment-method"]');
                if (firstPaymentMethod) {
                    firstPaymentMethod.checked = true;
                    firstPaymentMethod.dispatchEvent(new Event('change', { bubbles: true }));
                }
                selectScenario('moderate');
                applyCustomization();
                setupEventListeners();
            } catch (e) {
                console.error("Erro durante a inicialização da calculadora:", e);
                alert("Ocorreu um erro ao carregar a calculadora. Verifique o console para mais detalhes.");
            }
        };

        init();
    });
    </script>
</body>
</html>
